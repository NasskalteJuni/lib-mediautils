<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lobby</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/7.3.0/adapter.min.js"></script>
    <script src="handle.js"></script>
    <script src="sendForm.js"></script>
    <script src="Call.js"></script>
</head>
<body>
    <header>
        <a href="create.html">Create new Lobby</a>
    </header>
    <main>
        <div id="lobby">
            <video id="video" autoplay></video>
            <ul id="messages">

            </ul>
            <form name="send" method="POST">
                <input type="text" placeholder="..." name="message">
                <button type="submit">Send</button>
            </form>
            <video id="v"></video>
            <button id="media">Join Call</button>
            <button id="close" disabled>Leave Call</button>
        </div>
        <div id="list">

        </div>
    </main>
    <script>
        (async () => {
            const query = new URLSearchParams(window.location.search);
            const lobbyId = query.get("id");
            if(lobbyId){
                document.getElementById('list').style.display = 'none';
                await fetch('/lobby/'+lobbyId+'/users', {method: 'POST'});
                const es = new EventSource('/lobby/'+lobbyId+'/updates');
                es.send = msg => fetch('/lobby/'+lobbyId+'/server',{method: 'POST', body: JSON.stringify(msg), headers: {"Accept":"application/json","Content-Type":"application/json"}});
                es.addEventListener('message', e => document.getElementById('messages').innerText += e.data);
                es.addEventListener('open', () => console.log('opened event stream'));
                es.addEventListener('error', e => console.error(e));
                es.addEventListener('close', () => console.log('closed event stream'));
                document.send.addEventListener('submit', function send(e) {
                    e.preventDefault();
                    sendForm('/lobby/'+lobbyId+'/message').then(() => document.send.message.value = "").catch(console.error);
                    return false;
                });
                window.call = new Call(es);
                const video = document.getElementById('video');
                const videoInput = new MediaStream([]);
                canvas.srcObject = videoInput;
                call.onTrack(track => {
                    track.addEventListener('ended', videoInput.removeTrack(track));
                    videoInput.addTrack(track);
                });
                const unlockMedia = document.getElementById('media');
                const closeMedia = document.getElementById('close');
                unlockMedia.addEventListener('click', async () =>  {
                    const ownStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                    window.call.addMedia(ownStream);
                    closeMedia.disabled = false;
                    unlockMedia.disabled = true;
                });
                closeMedia.addEventListener('click', () => {
                    window.call.destroy();
                    unlockMedia.diabled = false;
                    closeMedia.disabled = true;
                });
            }else{
                document.getElementById('lobby').style.display = 'none';
                fetch('/lobbies/').then(handle).then(response => response.json()).then(lobbies => '<ul>'+lobbies.map(lobby => `<li><a href="/lobby.html?id=${lobby.id}">${lobby.name}</a></li>`).join('\n')+'</ul>').then(html => document.getElementById('list').innerHTML = html).catch(console.error);
            }
        })();
    </script>
</body>
</html>